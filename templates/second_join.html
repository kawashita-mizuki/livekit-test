<!DOCTYPE html>
<html lang="ja">
<head>
    <title>LiveKit Demo</title>
    <link href="/static/front/css/styles.css" rel="stylesheet">
</head>
<body>
    <h3>後から入室する人用Room一覧</h3>
    <ul id="room-list">
        {% for room_name in room_names %}
        <li><a href="#" onclick="joinRoom('{{ room_name }}')">{{ room_name }}</a></li>
        {% endfor %}
    </ul>

    <div id="video-container">
        <div id="my-video-container" class="video-box">
            <div class="label">自分</div>
        </div>
        <div id="remote-video-container" class="video-box">
            <div class="label">相手</div>
        </div>
    </div>

    <div id="controls">
        <button id="toggle-mic">ミュート</button>
        <button id="toggle-camera">カメラオフ</button>
        <select id="video-devices">
            <option value="">カメラ切り替え</option>
        </select>
        <select id="audio-devices">
            <option value="">マイク切り替え</option>
        </select>
        <button id="leave-room">退室</button>
    </div>

    <script type="module">
        import { connect, createLocalVideoTrack, createLocalAudioTrack, RoomEvent } from 'https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.js';

        let localVideoTrack, localAudioTrack;
        let room;
        let isCameraOn = true;
        let isMicOn = true;

        // ルームに参加するための関数
        window.joinRoom = async function(roomName) {
            const userIdentity = "後から入室した人";
            const tokenEndpoint = `/api/token?room=${roomName}&user_identity=${userIdentity}`;
            const response = await fetch(tokenEndpoint);
            const data = await response.json();

            if (data.token) {
                room = await connect('wss://livekit-test.colabmix.jp/livekit_server', data.token);

                localVideoTrack = await createLocalVideoTrack();
                localAudioTrack = await createLocalAudioTrack();

                const videoElement = localVideoTrack.attach();
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                document.getElementById('my-video-container').appendChild(videoElement);

                await room.localParticipant.publishTrack(localVideoTrack);
                await room.localParticipant.publishTrack(localAudioTrack);

                room.participants.forEach(participant => {
                    participant.tracks.forEach(publication => {
                        if (publication.track && publication.track.kind === 'video') {
                            const remoteVideoElement = publication.track.attach();
                            remoteVideoElement.autoplay = true;
                            remoteVideoElement.playsInline = true;
                            document.getElementById('remote-video-container').appendChild(remoteVideoElement);
                        } else if (publication.track && publication.track.kind === 'audio') {
                            const remoteAudioElement = publication.track.attach();
                            document.body.appendChild(remoteAudioElement);
                        }
                    });
                });

                 // 他の参加者のビデオトラックを購読
                room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === 'video') {
                        const videoElement = track.attach();
                        document.getElementById('remote-video-container').appendChild(videoElement);
                    } else if (track.kind === 'audio') {
                        const audioElement = track.attach();
                        document.getElementById('remote-video-container').appendChild(audioElement);
                    }
                });

                // 他の参加者のトラックがアンパブリッシュされた場合の処理
                room.on(RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                    if (track.kind === 'video') {
                        const elements = track.detach();
                        elements.forEach(element => element.remove());
                    } else if (track.kind === 'audio') {
                        const elements = track.detach();
                        elements.forEach(element => element.remove());
                    }
                });

                populateDeviceLists();
            } else {
                console.error('トークンの取得に失敗');
            }
        }

        async function populateDeviceLists() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            const audioDevices = devices.filter(device => device.kind === 'audioinput');
            
            const videoSelect = document.getElementById('video-devices');
            const audioSelect = document.getElementById('audio-devices');

            videoSelect.innerHTML = '<option value="">カメラ切り替え</option>';
            audioSelect.innerHTML = '<option value="">マイク切り替え</option>';

            videoDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${videoSelect.length + 1}`;
                videoSelect.appendChild(option);
            });

            audioDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Microphone ${audioSelect.length + 1}`;
                audioSelect.appendChild(option);
            });
        }

        document.getElementById('toggle-mic').addEventListener('click', () => {
            isMicOn = !isMicOn;
            localAudioTrack.mediaStreamTrack.enabled = isMicOn;
            document.getElementById('toggle-mic').innerText = isMicOn ? 'ミュート' : 'ミュート解除';
        });

        document.getElementById('toggle-camera').addEventListener('click', () => {
            isCameraOn = !isCameraOn;
            localVideoTrack.mediaStreamTrack.enabled = isCameraOn;
            document.getElementById('toggle-camera').innerText = isCameraOn ? 'カメラオフ' : 'カメラオン';
        });

        document.getElementById('leave-room').addEventListener('click', () => {
            if (room) {
                room.disconnect();
                document.getElementById('my-video-container').innerHTML = '';
                document.getElementById('remote-video-container').innerHTML = '';
            }
        });

        // カメラ切り替え
        document.getElementById('video-devices').addEventListener('change', async () => {
            const deviceId = document.getElementById('video-devices').value;
            if (deviceId) {
                // 古いトラックをアンパブリッシュして停止
                await room.localParticipant.unpublishTrack(localVideoTrack);
                localVideoTrack.stop();
                localVideoTrack.detach().forEach(element => element.remove());

                // 新しいトラックを作成してパブリッシュ
                localVideoTrack = await createLocalVideoTrack({ deviceId });
                const videoElement = localVideoTrack.attach();
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                document.getElementById('my-video-container').innerHTML = '';
                document.getElementById('my-video-container').appendChild(videoElement);
                await room.localParticipant.publishTrack(localVideoTrack);
            }
        });

        // マイク切り替え
        document.getElementById('audio-devices').addEventListener('change', async () => {
            const deviceId = document.getElementById('audio-devices').value;
            if (deviceId) {
                // 古いトラックをアンパブリッシュして停止
                await room.localParticipant.unpublishTrack(localAudioTrack);
                localAudioTrack.stop();

                // 新しいトラックを作成してパブリッシュ
                localAudioTrack = await createLocalAudioTrack({ deviceId });
                await room.localParticipant.publishTrack(localAudioTrack);
            }
        });
    </script>
</body>
</html>
