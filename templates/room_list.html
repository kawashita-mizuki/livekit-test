<!DOCTYPE html>
<html lang="ja">
<head>
    <title>LiveKit Demo</title>
    <!-- <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script> -->
    <link href="/static/front/css/styles.css" rel="stylesheet">
</head>
<body>
    <h3>Room一覧</h3>
    <ul id="room-list">
        {% for room_name in room_names %}
        <li><a href="#" onclick="joinRoom('{{ room_name }}')">{{ room_name }}</a></li>
        {% endfor %}
    </ul>

    <div id="my-video-container"></div>
    <div id="remote-video-container"></div>

    <script type="module">
        import { connect, createLocalVideoTrack, Room, RoomEvent, ParticipantEvent, RemoteTrackPublication, RemoteParticipant, VideoPresets } from 'https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.js';

        // ルームに参加するための関数
        window.joinRoom = async function(roomName) {
            // トークン取得
            const tokenEndpoint = `/api/token?room=${roomName}`;
            const response = await fetch(tokenEndpoint);
            const data = await response.json();

            if (data.token) {
                const room = await connect('wss://livekit-test.colabmix.jp/livekit_server', data.token);
                console.log('接続成功:', roomName);

                // 自分のビデオトラックを生成して公開
                const localVideoTrack = await createLocalVideoTrack();
                const videoElement = localVideoTrack.attach();
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                document.getElementById('my-video-container').appendChild(videoElement);

                await room.localParticipant.publishTrack(localVideoTrack);
                console.log('ビデオトラックがパブリッシュ');

                // イベントリスナーの設定
                room
                    .on(RoomEvent.TrackSubscribed, handleTrackSubscribed)
                    .on(RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed)
                    .on(RoomEvent.ParticipantConnected, handleParticipantConnected)
                    .on(RoomEvent.Disconnected, handleDisconnect);

                // 既存の参加者のトラックを確認
                room.participants.forEach(participant => {
                    console.log(`既存の参加者: ${participant.identity}`);
                    participant.tracks.forEach(publication => {
                        if (publication.isSubscribed && publication.track.kind === 'video') {
                            const remoteVideoElement = publication.track.attach();
                            remoteVideoElement.autoplay = true;
                            remoteVideoElement.playsInline = true;
                            document.getElementById('remote-video-container').appendChild(remoteVideoElement);
                            console.log(`既存の参加者のビデオトラックが表示されました: ${participant.identity}`);
                        } else {
                            publication.on(ParticipantEvent.TrackSubscribed, handleTrackSubscribed);
                        }
                    });
                });
            } else {
                console.error('トークンの取得に失敗しました');
            }
        }

        function handleTrackSubscribed(track, publication, participant) {
            console.log(`TrackSubscribedイベント: kind=${track.kind}, participant=${participant.identity}`);
            if (track.kind === 'video') {
                const videoElement = track.attach();
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                document.getElementById('remote-video-container').appendChild(videoElement);
                console.log(`他の参加者のビデオトラックがサブスクライブされました: ${participant.identity}`);
            }
        }

        function handleTrackUnsubscribed(track, publication, participant) {
            console.log(`TrackUnsubscribedイベント: kind=${track.kind}, participant=${participant.identity}`);
            if (track.kind === 'video') {
                const elements = track.detach();
                elements.forEach(element => element.remove());
                console.log(`他の参加者のビデオトラックが取り消されました: ${participant.identity}`);
            }
        }

        function handleParticipantConnected(participant) {
            console.log(`ParticipantConnectedイベント: participant=${participant.identity}`);
            participant.tracks.forEach(publication => {
                if (publication.track && publication.track.kind === 'video' && publication.isSubscribed) {
                    const remoteVideoElement = publication.track.attach();
                    remoteVideoElement.autoplay = true;
                    remoteVideoElement.playsInline = true;
                    document.getElementById('remote-video-container').appendChild(remoteVideoElement);
                    console.log(`新しい参加者のビデオトラックが表示されました: ${participant.identity}`);
                }
                publication.on(ParticipantEvent.TrackSubscribed, handleTrackSubscribed);
            });
        }

        function handleDisconnect() {
            console.log('disconnected from room');
        }

    </script>
</body>
</html>
